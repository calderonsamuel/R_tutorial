---
title: "Basicos_R"
toc: true
#knit: (function(input_file, encoding) {
#  out_dir <- 'docs';
#  rmarkdown::render(input_file,
# encoding=encoding,
# output_file=file.path(dirname(input_file), out_dir, 'Basicos_R.html'))})
#author: "Paloma B"
#date: "7/2/2019"
#output: html_document
#    css: test.css
#  pdf_document: default
---
<style>
#TOC {
  top: 1%;
  opacity: 0.5;
}
#TOC:hover {
  opacity: 1;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tabla de Contenidos

Parte I: 

- [Descargando e instalando R](#T1)
- [La consola de R y comandos basicos](#T2)
- [Subiendo una base de datos](#T3)
  

Parte II: Manipular y limpiar base de datos

- Recode
- Rename y re label
- gen variable (categorica, dicotomica, average de grupo)
- Missing -- finding them (no sean en 0s si se grabo asi -- a missing )

Parte III: Estadisticos descriptivos

- Media, mediana, moda, SD
- Graficos simples de distribucion
- Percentiles
- Dos variables -- diferencia de medias, correlaciones, GRaficosde distribucion y  correlacion

Parte IV: Analisis y Graficos

- Regresion simple y diagnostico
- Graficos de ajustes de regresion
- Controlando por otras variables
- Cluster SE
- Efectos fijos
- Probit/logit -- odss ratio y marginal efects


## Parte I: Basicos del R

### Basicos. 

Cuando inicias **R** se activan un grupo básicos de paquetes. Los paquetes tienen funciones y las funciones argumentos. 

Puedes instalar paquetes usando ```install.packages("nombre del paquete")```.  Los paquetes se instalan una sola vez. Luego de eso ya estan en la memoria de tu computadora.

Cada vez que necesitas un paquete lo puedes llamar con: ```library(paquete)```. 

Por ejemplo si corres un código y el resultado es un error con un mensaje que dice: **could not find function "xxx"**. Entonces no has llamado el paquete (usando library) y si llamas al paqute y te resulta un error con el siguiente mensaje: **Error in library(paquete) : there is no package called ‘paquete’** significa que necesitas instalarlo. 

### Subiendo una base de datos <a name="T3"></a>

Para subir una base de datos (BD), debes antes haber instalado una serie de paquetes que permiten leer la base de datos sin importar en que formato este. Existen varios paquetes que nos pueden ayudar con eso. En este tutorial trabajaremos con ```rio```. Rio nos permite abrir distintos tipos de base de datos con facilidad. 

```{r eval=FALSE}
install.packages("rio")
```

```{r, message=FALSE}
library(rio)
```

Segundo, llamamos a nuestra base de datos.

**IMPORTANTE** antes de interactura con folders (subir data, grabar resultados, gráficos, etc) tienes que establecer tu directorio de trabajo. La forma más rápida es con la rueda con la etiqueta "more" en el panel derecho. 

```{r echo=FALSE, out.width='80%'}
knitr::include_graphics('./data_examples/Rstudio_setwd.png')
```

La base de datos debe estar en nuestro espacio de trabajo. 
La Base de Datos que usaremos es una muestra de la ENAHO - PERU (Encuesta Nacional de Hogares del Peru) del 2017. Para facilidad del ejercicio, hemos tomado solo a los jefes de hogar de Lima Metropolitana. Tenemos informacion sobre su etnicidad, nivel educativo, ingresos y empleo.

Dado que tenemos el paquete rio, no necesitamos decirle a R que nuestra base de datos esta en STATA, R lo entiende. 

Vamos a usar el comando import y asignarle un nombre a nuestra base de datos como hicimos al inicio. Lo llamaremos Ej_Enaho. Abajo podemos ver las primeras 4 variables y primeras 10 observaciones.

```{r}
Ej_Enaho<-import("./data_examples/Ejercicio_Enaho2017.dta")
head(Ej_Enaho[,1:5],10)
```

Siempre es bueno mirar la base de datos con la cual estamos trabajando para darnos una idea mas concreta de que estamos haciendo. Para hacer ello, usamos el comando View y llamamos nuestra base de datos. Tenemos  una base de datos manejable, pero si es que tuvieramos una de 50 000 observaciones o mas? Podriamos mirar una muestra de nuestra base de datos con la opcion head. Abajo, le pedimos que nos puestre las 300 primeras observaciones. Arriba le pedimos que nos muestre de las variables 1 a 5, las 10 primeras observaciones. 

```{r, eval=FALSE}
View(Ej_Enaho)
View(head(Ej_Enaho,300))
```


## Parte II: Manipular y limpiar base de datos

En esta secciones aprenderemos algunas de los pasos mas frecuentes que hacemos al encontrarnos con una nueva base de datos: limpiar y manipular algunas variables para que pueda analizarse. Debemos limpiar nuestra base de datos por muchas razones; quizas para calcular las variables que queremos, para desacernos de grupos de observaciones que no nos interesan o para hacer mas facil el juntar nuestra base de datos con otras.

Vamos a utilizar el paquete "Hmisc" y el paquete "ipumsr" que nos facilitan renombrar y etiquetar variables. 

```{r, message=FALSE}
#install.packages("Hmisc")
library(Hmisc)
#install.packages("ipumsr")
library(ipumsr)
```

### Re-nombrar y etiquetar variables

Vamos a empezar cambiando el nombre de algunas de nuestras variables. Vemos nuestras variables en la BD con el comando List (ls).

```{r, message=FALSE}
ls(Ej_Enaho)
```

Describamos la variable "ocupinf". Vemos su etiqueta, los valores que toma (1/2) y su media.

```{r}
#describe(Ej_Enaho$ocupinf)
```

Digamos que queremos cambiar el nombre de la variable "ocupinf" a "emp_formal". Para ello usamos la funcion names. Le decimos a R que en donde encuentre el nombre "ocupinf" lo reemplaze por "emp_formal". Ahora miramos la lista de variables de nuevo y vemos que cambio a "emp_formal".

```{r}
names(Ej_Enaho)[names(Ej_Enaho) == "ocupinf"] <- "empl_formal"
ls(Ej_Enaho)
```

Queremos cambiar la etiqueta de esta variable para que no tenga typos y este mejor explicada:

```{r}
label(Ej_Enaho$empl_formal) <- "Situacion de informalidad en la ocup.principal"
describe(Ej_Enaho$empl_formal)
```

### Recodificar variables

Ahora recodificaremos los valores de la variable con que estamos trabajando.

Usamos la funcion abajo para ver los valores y las etiquetas de la variable que creamos.
```{r}
ipums_val_labels(Ej_Enaho$empl_formal)
```

Vemos que 1=empleo informal y 2=empleo formal. Como nuestra variable se llama empl_formal, queremos que tome valor de 1 si la persona tiene empleo formal y 0 de otro modo.
```{r}
Ej_Enaho$empl_formal[Ej_Enaho$empl_formal==1] <- 0 #Si la variable tiene valor de 1, reemplazalo por 0
Ej_Enaho$empl_formal[Ej_Enaho$empl_formal==2] <- 1 #Si la variable tiene valor de 2, reemplazalo por 1
```

Ahora podemos usar esta variable con mucha mas facilidad. Por ejemplo, podemos tomar el promedio e interpretarlo. Vemos que alrededor del 50% de nuestros informantes tiene empleo formal.
```{r}
describe(Ej_Enaho$empl_formal)
```
 
## Generar variables (categorica, dicotomica, average de grupo)

Ahora vamos a generar distintos tipos de variables. Empecemos con una variable dicotomica. Vamos a usar informacion sobre la etnicidad reportada de los informantes.

```{r}
#describe(Ej_Enaho$p558c)
ipums_val_labels(Ej_Enaho$p558c)
```

## Variable binaria

Generemos una variable que toma el valor de 1 si es que el informante pertenece a un pueblo indigena y 0 si es que no. Creamos una variable vacia y le incluimos los argumentos:

```{r}
Ej_Enaho$indigena<- NA
Ej_Enaho[Ej_Enaho$p558c%in%c(1:3,9), ]$indigena <- 1 #Si le pregunta p558c es 1,2,3 o 9, toma valor de 1
Ej_Enaho[Ej_Enaho$p558c%in%c(4,5,6,7,8), ]$indigena<-0 #Si le pregunta p558c es 4,5,6,7 o 8, toma valor de 0
```

Otra opcion es usar el comando ifelse:
```{r}
#Ej_Enaho$indigena<-ifelse(Ej_Enaho$p558c%in%c(1:3,9),1,0)
```

Ahora miramos nuestra variable Indigena:
```{r}
table(Ej_Enaho$indigena)
summary(Ej_Enaho$indigena)
```

## Variable categorica

Ahora crearemos una variable que incluya varios valores de etnicidad, pero menos que la pregunta original:
```{r}
Ej_Enaho$etnicidad<- NA
Ej_Enaho[Ej_Enaho$p558c%in%c(6), ]$etnicidad <- 1 #Si le pregunta p558c es 6 (mestizo), toma valor de 1
Ej_Enaho[Ej_Enaho$p558c%in%c(1:3,9), ]$etnicidad <- 2 #Si le pregunta p558c es 1,2,3 o 9 (indigena), toma valor de 2
Ej_Enaho[Ej_Enaho$p558c%in%c(5), ]$indigena<-3 #Si le pregunta p558c es 5 (blanco), toma valor de 3
Ej_Enaho[Ej_Enaho$p558c%in%c(4), ]$indigena<-4 #Si le pregunta p558c es 4 (afroperuano), toma valor de 4
Ej_Enaho[Ej_Enaho$p558c%in%c(7,8), ]$indigena<-5 #Si le pregunta p558c es 7,8 (NS/Otro), toma valor de 5
```

Ahora miramos nuestra variable Indigena:
```{r}
table(Ej_Enaho$etnicidad)
summary(Ej_Enaho$etnicidad)
```


## ADD INCIO: Missing -- finding them (no sean en 0s si se grabo asi -- a missing )


## Parte III: Descripcion y  graficos basicos

### Descripcion de una variable

Ahora haremos un poco de estadistica descriptiva basica. Hemos estado usando el comando describe bastate, es porque este comando nos da la informacion descriptiva basica de cada variable. 

Usemos la ingresos_mensual (expresada en nuevos soles -- 1$=~3.3 soles):

```{r}
describe(Ej_Enaho$ingresos_mens_indv)
```

Tambien podemos pedir la informacion de forma independiente:
```{r}
mean(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE) #Usamos el argumento na.rm=TRUE para decir que nos de el resultado aunque haya missing values. Si no ponemos el argumento no sale.
sd(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE)
median(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE)
```

Podemos guardar la informacion de las medidas de tendencia central en una nueva variable: 
```{r}
mean_ingresos<-mean(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE)
sd_ingresos<-sd(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE)
median_ingresos<-median(Ej_Enaho$ingresos_mens_indv,na.rm=TRUE)
```

Podemos tambien sacar los percentiles de nuestra distribucion:
```{r}
quantile(Ej_Enaho$ingresos_mens_indv, na.rm = TRUE)
```


## ADD INCIO: crear variable que tome 1 si es que estan en el 25% superior de riqueza


Ahora haremos unos graficos simples de distribucion. Para ellos instalaremos el paquete ggplot2. Recomendamos usar esta cartilla de referencia: https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf

```{r}
#install.packages("ggplot2")
library(ggplot2)
```

Empecemos con el grafico mas basico:
```{r}
plot(Ej_Enaho$ingresos_mens_indv)
```

Ahora haremos un histograma:
```{r}
hist(Ej_Enaho$ingresos_mens_indv)
```

Es dificil visualizar la distribucion de la data porque esta muy dispersa, podemos seleccionar solo mirar los valores del 75% inferior hacia abajo:

## ADD : GRAFICO LIMITADO y mas opciones de grafico

### Descripcion de dos variables

Ahora haremos estadistica descriptiva de dos variables.

Veamos la relacion entre nivel educativo e ingresos mensuales. Primero miremos la variable nivel educativo:
```{r}
summary(Ej_Enaho$educ_nivel)
ipums_val_labels(Ej_Enaho$educ_nivel) # Vemos que tiene una escala ordina (12 no tiene valores)
table(Ej_Enaho$educ_nivel)
```

A continuacion, cruzamos ambas variables. Emplezamos con correlaciones:
```{r}
cor(Ej_Enaho$ingresos_mens_indv,Ej_Enaho$educ_nivel)
```

ADD :Ahora hacemos una diferencia de medias

Ahora hacemos un grafico de distribucion bivariado:
```{r}
plot(Ej_Enaho$ingresos_mens_indv,Ej_Enaho$educ_nivel)
```

## Parte IV: Analisis

Para el analisis, usaremos la variable ingresos como la variable dependiente y educacion como la variable independiente.

- Regresion simple y diagnostico
```{r}
OLS_1 <- lm(ingresos_mens_indv ~ educ_nivel, data=Ej_Enaho)
summary(OLS_1)
```
```{r}
coefficients(OLS_1) # model coefficients
confint(OLS_1, level=0.95) # CIs for model parameters 
#fitted(OLS_1) # predicted values
#residuals(OLS_1) # residuals
anova(OLS_1) # anova table 
vcov(OLS_1) # covariance matrix for model parameters 
#influence(OLS_1) # regression diagnostics
```

- Graficos de ajustes de regresion

- Controlando por otras variables


- Cluster SE
OLS_3 <- lm(ingresos_mens_indv ~ educ_nivel, data=Ej_Enaho)

- Efectos fijos

- Probit/logit -- odss ratio y marginal efects




(regresiones de paper mody)


```{r}

```

```{r}

```





## Tema2 <a name="T2"></a>
This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r }
summary(cars)
```
## Tema3 <a name="T3"></a>
##
##
##
##
